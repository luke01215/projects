<!DOCTYPE html>
<html>
<head>
    <title>Email Scanner Review</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: #2c3e50; color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .stat-value { font-size: 24px; font-weight: bold; color: #3498db; }
        .email-list { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .view-toggle { display: flex; gap: 10px; margin-bottom: 20px; }
        .view-toggle button { padding: 10px 20px; border: 2px solid #3498db; background: white; color: #3498db; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .view-toggle button.active { background: #3498db; color: white; }
        .sender-item { border-bottom: 1px solid #eee; padding: 15px 0; cursor: pointer; }
        .sender-item:hover { background: #f9f9f9; padding-left: 10px; }
        .sender-name { font-weight: bold; color: #2c3e50; font-size: 16px; }
        .sender-meta { color: #7f8c8d; font-size: 14px; margin: 5px 0; }
        .email-count { display: inline-block; background: #3498db; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; margin-right: 10px; }
        .email-item { border-bottom: 1px solid #eee; padding: 15px 0; cursor: pointer; }
        .email-item:hover { background: #f9f9f9; padding-left: 10px; }
        .email-sender { font-weight: bold; color: #2c3e50; }
        .email-subject { color: #555; margin: 5px 0; }
        .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; margin-right: 10px; }
        .badge-delete { background: #e74c3c; color: white; }
        .badge-keep { background: #27ae60; color: white; }
        .badge-archive { background: #f39c12; color: white; }
        .confidence { color: #7f8c8d; font-size: 14px; margin-right: 15px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal-content { background: white; margin: 50px auto; padding: 30px; max-width: 800px; border-radius: 8px; max-height: 80vh; overflow-y: auto; }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin: 5px; }
        .btn-approve { background: #27ae60; color: white; }
        .btn-reject { background: #e74c3c; color: white; }
        .btn-close { background: #95a5a6; color: white; }
        .loading { text-align: center; padding: 20px; color: #7f8c8d; }
        .error { color: #e74c3c; background: #ffe6e6; padding: 10px; border-radius: 4px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìß Email Scanner Review Interface</h1>
            <p>Review AI recommendations for email deletion</p>
        </div>
        
        <div class="stats" id="stats">
            <div class="stat-card">
                <div class="stat-value" id="pending-count">-</div>
                <div>Pending Review</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="processed-count">-</div>
                <div>Total Processed</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="accuracy-rate">-</div>
                <div>AI Accuracy</div>
            </div>
        </div>
        
        <div class="email-list">
            <div class="view-toggle">
                <button id="view-senders-btn" class="active" onclick="switchView('senders')">ÔøΩ By Sender</button>
                <button id="view-categories-btn" onclick="switchView('categories')">üìÇ By Category</button>
                <button id="view-dates-btn" onclick="switchView('dates')">üìÖ By Date</button>
                <button id="view-individual-btn" onclick="switchView('individual')">üìß Individual</button>
            </div>
            
            <div id="senders-view">
                <h2>Pending Reviews - Grouped by Sender</h2>
                <div id="sender-container">
                    <div class="loading">Loading senders...</div>
                </div>
            </div>
            
            <div id="categories-view" style="display:none;">
                <h2>Pending Reviews - Grouped by Category</h2>
                <div id="category-container">
                    <div class="loading">Loading categories...</div>
                </div>
            </div>
            
            <div id="dates-view" style="display:none;">
                <h2>Pending Reviews - Grouped by Date Range</h2>
                <div id="date-range-container">
                    <div class="loading">Loading date ranges...</div>
                </div>
            </div>
            
            <div id="individual-view" style="display:none;">
                <h2>Pending Reviews - Individual Emails</h2>
                <div style="margin-bottom: 20px;">
                    <input type="text" id="search-input" placeholder="üîç Search sender, subject, or content..." 
                           style="width: 400px; padding: 8px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
                    <button onclick="searchEmails()" style="padding: 8px 16px; margin-left: 8px; cursor: pointer;">Search</button>
                    <button onclick="clearSearch()" style="padding: 8px 16px; margin-left: 4px; cursor: pointer;">Clear</button>
                    <label style="margin-left: 20px;">
                        <input type="checkbox" id="unviewed-only" onchange="loadEmails()"> Show only unviewed emails
                    </label>
                </div>
                <div id="email-container">
                    <div class="loading">Loading emails...</div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal" id="email-modal">
        <div class="modal-content" id="modal-content">
            <!-- Email details will be loaded here -->
        </div>
    </div>
    
    <script>
        let currentEmailId = null;
        let currentView = 'senders';
        let currentSender = null;
        let currentCategory = null;
        let currentDateRange = null;
        let currentGroupContext = null;  // 'sender', 'category', or 'dateRange'
        let currentGroupIndex = null;     // index of the group being viewed
        
        // Store data for click handlers
        let sendersData = [];
        let categoriesData = [];
        let dateRangesData = [];
        
        function switchView(view) {
            currentView = view;
            
            // Hide all views
            document.getElementById('senders-view').style.display = 'none';
            document.getElementById('categories-view').style.display = 'none';
            document.getElementById('dates-view').style.display = 'none';
            document.getElementById('individual-view').style.display = 'none';
            
            // Remove active class from all buttons
            document.getElementById('view-senders-btn').classList.remove('active');
            document.getElementById('view-categories-btn').classList.remove('active');
            document.getElementById('view-dates-btn').classList.remove('active');
            document.getElementById('view-individual-btn').classList.remove('active');
            
            // Show selected view
            if (view === 'senders') {
                document.getElementById('senders-view').style.display = 'block';
                document.getElementById('view-senders-btn').classList.add('active');
                loadSenders();
            } else if (view === 'categories') {
                document.getElementById('categories-view').style.display = 'block';
                document.getElementById('view-categories-btn').classList.add('active');
                loadCategories();
            } else if (view === 'dates') {
                document.getElementById('dates-view').style.display = 'block';
                document.getElementById('view-dates-btn').classList.add('active');
                loadDateRanges();
            } else {
                document.getElementById('individual-view').style.display = 'block';
                document.getElementById('view-individual-btn').classList.add('active');
                loadEmails();
            }
        }
        
        async function loadSenders() {
            try {
                const response = await fetch('/api/senders/pending');
                if (!response.ok) throw new Error('Senders request failed');
                sendersData = await response.json();
                
                const container = document.getElementById('sender-container');
                
                if (sendersData.length === 0) {
                    container.innerHTML = '<div class="loading">No emails pending review</div>';
                    return;
                }
                
                container.innerHTML = sendersData.map((sender, index) => 
                    '<div class="sender-item" onclick="showSenderEmails(' + index + ')">' +
                        '<div class="sender-name">' + escapeHtml(sender.sender) + '</div>' +
                        '<div class="sender-meta">' +
                            '<span class="email-count">' + sender.email_count + ' emails</span>' +
                            '<span class="badge badge-' + sender.most_common_recommendation + '">' + sender.most_common_recommendation.toUpperCase() + '</span>' +
                            '<span class="confidence">Avg confidence: ' + (sender.avg_confidence * 100).toFixed(0) + '%</span>' +
                            '<span class="confidence">Category: ' + sender.most_common_category + '</span>' +
                        '</div>' +
                        '<div class="email-subject" style="font-size:14px; color:#999;">Sample: ' + escapeHtml(sender.sample_subject) + '</div>' +
                    '</div>'
                ).join('');
            } catch (error) {
                console.error('Error loading senders:', error);
                document.getElementById('sender-container').innerHTML = 
                    '<div class="error">Error loading senders: ' + error.message + '</div>';
            }
        }
        
        async function showSenderEmails(senderIndex) {
            try {
                const sender = sendersData[senderIndex].sender;
                currentSender = sender;
                currentGroupContext = 'sender';
                currentGroupIndex = senderIndex;
                const response = await fetch('/api/senders/' + encodeURIComponent(sender) + '/emails');
                if (!response.ok) throw new Error('Failed to load sender emails');
                const emails = await response.json();
                
                let modalHtml = '<h2>Emails from: ' + escapeHtml(sender) + '</h2>' +
                    '<p><strong>' + emails.length + ' emails pending review</strong></p>' +
                    '<div style="max-height: 400px; overflow-y: auto; margin: 15px 0;">';
                
                emails.forEach(email => {
                    modalHtml += '<div style="padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s;" ' +
                        'onmouseover="this.style.background=\'#f5f5f5\'" ' +
                        'onmouseout="this.style.background=\'white\'" ' +
                        'onclick="showEmailDetail(' + email.id + ')">' +
                        '<div><strong>' + escapeHtml(email.subject) + '</strong></div>' +
                        '<div style="font-size:12px; color:#999;">' + new Date(email.received_date).toLocaleDateString() + ' - ID: ' + email.email_id + '</div>' +
                        '<span class="badge badge-' + email.recommendation + '">' + email.recommendation.toUpperCase() + '</span>' +
                        '<span class="confidence">Confidence: ' + (email.confidence_score * 100).toFixed(0) + '%</span>' +
                    '</div>';
                });
                
                modalHtml += '</div>' +
                    '<div style="margin-top: 20px;">' +                        '<button class="btn" style="background:#2ecc71; color:white;" onclick="applyRecommendations()">ü§ñ Apply AI Recommendations</button>' +                        '<button class="btn btn-approve" onclick="makeBulkDecision(\'kept\', \'' + emails[0].recommendation + '\')">‚úì Keep All</button>' +
                        '<button class="btn btn-reject" onclick="makeBulkDecision(\'deleted\', \'' + emails[0].recommendation + '\')">‚úó Delete All</button>' +
                        '<button class="btn" style="background:#f39c12; color:white;" onclick="makeBulkDecision(\'archived\', \'' + emails[0].recommendation + '\')">üóÑÔ∏è Archive All</button>' +
                        '<button class="btn btn-close" onclick="closeModal()">Cancel</button>' +
                    '</div>';
                
                document.getElementById('modal-content').innerHTML = modalHtml;
                document.getElementById('email-modal').style.display = 'block';
            } catch (error) {
                console.error('Error showing sender emails:', error);
                alert('Error loading sender emails: ' + error.message);
            }
        }
        
        async function applyRecommendations() {
            try {
                if (!currentSender) {
                    alert('No sender selected');
                    return;
                }
                
                if (!confirm('Apply AI recommendations to all emails from this sender?')) {
                    return;
                }
                
                const response = await fetch('/api/senders/apply-recommendations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sender: currentSender })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert('‚úÖ ' + result.message);
                    closeModal();
                    loadStats();
                    await loadSenders();
                } else {
                    alert('Error applying recommendations');
                }
            } catch (error) {
                console.error('Error applying recommendations:', error);
                alert('Error: ' + error.message);
            }
        }
        
        async function makeBulkDecision(action, aiRecommendation) {
            try {
                // Determine if we're agreeing with AI recommendation
                const approved = (action === 'deleted' && aiRecommendation === 'delete') || 
                                (action === 'kept' && aiRecommendation === 'keep') ||
                                (action === 'archived' && aiRecommendation === 'archive');
                
                const response = await fetch('/api/senders/decide-bulk', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        sender: currentSender,
                        approved: approved, 
                        action_taken: action 
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert('‚úÖ ' + result.message);
                    closeModal();
                    loadStats();
                    loadSenders();
                } else {
                    alert('Error recording bulk decision');
                }
            } catch (error) {
                console.error('Error making bulk decision:', error);
                alert('Error: ' + error.message);
            }
        }
        
        async function loadCategories() {
            try {
                const response = await fetch('/api/categories/pending');
                if (!response.ok) throw new Error('Categories request failed');
                categoriesData = await response.json();
                
                const container = document.getElementById('category-container');
                
                if (categoriesData.length === 0) {
                    container.innerHTML = '<div class="loading">No emails pending review</div>';
                    return;
                }
                
                container.innerHTML = categoriesData.map((cat, index) => 
                    '<div class="sender-item" onclick="showCategoryEmails(' + index + ')">' +
                        '<div class="sender-name">üìÇ ' + escapeHtml(cat.category).toUpperCase() + '</div>' +
                        '<div class="sender-meta">' +
                            '<span class="email-count">' + cat.email_count + ' emails</span>' +
                            '<span class="badge badge-' + cat.most_common_recommendation + '">' + cat.most_common_recommendation.toUpperCase() + '</span>' +
                            '<span class="confidence">Avg confidence: ' + (cat.avg_confidence * 100).toFixed(0) + '%</span>' +
                        '</div>' +
                        '<div class="email-subject" style="font-size:14px; color:#999;">Sample: ' + escapeHtml(cat.sample_subject) + '</div>' +
                    '</div>'
                ).join('');
            } catch (error) {
                console.error('Error loading categories:', error);
                document.getElementById('category-container').innerHTML = 
                    '<div class="error">Error loading categories: ' + error.message + '</div>';
            }
        }
        
        async function showCategoryEmails(categoryIndex) {
            try {
                const category = categoriesData[categoryIndex].category;
                currentCategory = category;
                currentGroupContext = 'category';
                currentGroupIndex = categoryIndex;
                const response = await fetch('/api/categories/' + encodeURIComponent(category) + '/emails');
                if (!response.ok) throw new Error('Failed to load category emails');
                const emails = await response.json();
                
                let modalHtml = '<h2>Category: ' + escapeHtml(category).toUpperCase() + '</h2>' +
                    '<p><strong>' + emails.length + ' emails pending review</strong></p>' +
                    '<div style="max-height: 400px; overflow-y: auto; margin: 15px 0;">';
                
                emails.forEach(email => {
                    modalHtml += '<div style="padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s;" ' +
                        'onmouseover="this.style.background=\'#f5f5f5\'" ' +
                        'onmouseout="this.style.background=\'white\'" ' +
                        'onclick="showEmailDetail(' + email.id + ')">' +
                        '<div><strong>' + escapeHtml(email.sender) + '</strong></div>' +
                        '<div>' + escapeHtml(email.subject) + '</div>' +
                        '<div style="font-size:12px; color:#999;">' + new Date(email.received_date).toLocaleDateString() + ' - ID: ' + email.email_id + '</div>' +
                        '<span class="badge badge-' + email.recommendation + '">' + email.recommendation.toUpperCase() + '</span>' +
                        '<span class="confidence">Confidence: ' + (email.confidence_score * 100).toFixed(0) + '%</span>' +
                    '</div>';
                });
                
                modalHtml += '</div>' +
                    '<div style="margin-top: 20px;">' +                        '<button class="btn" style="background:#2ecc71; color:white;" onclick="applyCategoryRecommendations()">ü§ñ Apply AI Recommendations</button>' +                        '<button class="btn btn-approve" onclick="makeBulkCategoryDecision(\'kept\', \'' + emails[0].recommendation + '\')">‚úì Keep All</button>' +
                        '<button class="btn btn-reject" onclick="makeBulkCategoryDecision(\'deleted\', \'' + emails[0].recommendation + '\')">‚úó Delete All</button>' +
                        '<button class="btn" style="background:#f39c12; color:white;" onclick="makeBulkCategoryDecision(\'archived\', \'' + emails[0].recommendation + '\')">üóÑÔ∏è Archive All</button>' +
                        '<button class="btn btn-close" onclick="closeModal()">Cancel</button>' +
                    '</div>';
                
                document.getElementById('modal-content').innerHTML = modalHtml;
                document.getElementById('email-modal').style.display = 'block';
            } catch (error) {
                console.error('Error showing category emails:', error);
                alert('Error loading category emails: ' + error.message);
            }
        }
        
        async function applyCategoryRecommendations() {
            try {
                if (!currentCategory) {
                    alert('No category selected');
                    return;
                }
                
                if (!confirm('Apply AI recommendations to all emails in this category?')) {
                    return;
                }
                
                const response = await fetch('/api/categories/apply-recommendations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ category: currentCategory })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert('‚úÖ ' + result.message);
                    closeModal();
                    loadStats();
                    await loadCategories();
                } else {
                    alert('Error applying recommendations');
                }
            } catch (error) {
                console.error('Error applying recommendations:', error);
                alert('Error: ' + error.message);
            }
        }
        
        async function makeBulkCategoryDecision(action, aiRecommendation) {
            try {
                // Determine if we're agreeing with AI recommendation
                const approved = (action === 'deleted' && aiRecommendation === 'delete') || 
                                (action === 'kept' && aiRecommendation === 'keep') ||
                                (action === 'archived' && aiRecommendation === 'archive');
                
                const response = await fetch('/api/categories/decide-bulk', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        category: currentCategory,
                        approved: approved, 
                        action_taken: action 
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert('‚úÖ ' + result.message);
                    closeModal();
                    loadStats();
                    loadCategories();
                } else {
                    alert('Error recording bulk decision');
                }
            } catch (error) {
                console.error('Error making bulk category decision:', error);
                alert('Error: ' + error.message);
            }
        }
        
        async function loadDateRanges() {
            try {
                const response = await fetch('/api/date-ranges/pending');
                if (!response.ok) throw new Error('Date ranges request failed');
                dateRangesData = await response.json();
                
                const container = document.getElementById('date-range-container');
                
                if (dateRangesData.length === 0) {
                    container.innerHTML = '<div class="loading">No emails pending review</div>';
                    return;
                }
                
                container.innerHTML = dateRangesData.map((range, index) => 
                    '<div class="sender-item" onclick="showDateRangeEmails(' + index + ')">' +
                        '<div class="sender-name">üìÖ ' + escapeHtml(range.date_range) + '</div>' +
                        '<div class="sender-meta">' +
                            '<span class="email-count">' + range.email_count + ' emails</span>' +
                            '<span class="badge badge-' + range.most_common_recommendation + '">' + range.most_common_recommendation.toUpperCase() + '</span>' +
                            '<span class="confidence">Category: ' + range.most_common_category + '</span>' +
                            '<span class="confidence">Avg confidence: ' + (range.avg_confidence * 100).toFixed(0) + '%</span>' +
                        '</div>' +
                        '<div class="email-subject" style="font-size:14px; color:#999;">Sample: ' + escapeHtml(range.sample_subject) + '</div>' +
                    '</div>'
                ).join('');
            } catch (error) {
                console.error('Error loading date ranges:', error);
                document.getElementById('date-range-container').innerHTML = 
                    '<div class="error">Error loading date ranges: ' + error.message + '</div>';
            }
        }
        
        async function showDateRangeEmails(rangeIndex) {
            try {
                const range = dateRangesData[rangeIndex];
                const startDate = range.start_date;
                const endDate = range.end_date;
                const rangeName = range.date_range;
                currentDateRange = { start: startDate, end: endDate, name: rangeName };
                currentGroupContext = 'dateRange';
                currentGroupIndex = rangeIndex;
                const response = await fetch('/api/date-ranges/emails?start_date=' + encodeURIComponent(startDate) + '&end_date=' + encodeURIComponent(endDate));
                if (!response.ok) throw new Error('Failed to load date range emails');
                const emails = await response.json();
                
                let modalHtml = '<h2>Date Range: ' + escapeHtml(rangeName) + '</h2>' +
                    '<p><strong>' + emails.length + ' emails pending review</strong></p>' +
                    '<div style="max-height: 400px; overflow-y: auto; margin: 15px 0;">';
                
                emails.forEach(email => {
                    modalHtml += '<div style="padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s;" ' +
                        'onmouseover="this.style.background=\'#f5f5f5\'" ' +
                        'onmouseout="this.style.background=\'white\'" ' +
                        'onclick="showEmailDetail(' + email.id + ')">' +
                        '<div><strong>' + escapeHtml(email.sender) + '</strong></div>' +
                        '<div>' + escapeHtml(email.subject) + '</div>' +
                        '<div style="font-size:12px; color:#999;">' + new Date(email.received_date).toLocaleDateString() + ' - ID: ' + email.email_id + '</div>' +
                        '<span class="badge badge-' + email.recommendation + '">' + email.recommendation.toUpperCase() + '</span>' +
                        '<span class="confidence">Confidence: ' + (email.confidence_score * 100).toFixed(0) + '%</span>' +
                    '</div>';
                });
                
                modalHtml += '</div>' +
                    '<div style="margin-top: 20px;">' +                        '<button class="btn" style="background:#2ecc71; color:white;" onclick="applyDateRangeRecommendations()">ü§ñ Apply AI Recommendations</button>' +                        '<button class="btn btn-approve" onclick="makeBulkDateRangeDecision(\'kept\', \'' + emails[0].recommendation + '\')">‚úì Keep All</button>' +
                        '<button class="btn btn-reject" onclick="makeBulkDateRangeDecision(\'deleted\', \'' + emails[0].recommendation + '\')">‚úó Delete All</button>' +
                        '<button class="btn" style="background:#f39c12; color:white;" onclick="makeBulkDateRangeDecision(\'archived\', \'' + emails[0].recommendation + '\')">üóÑÔ∏è Archive All</button>' +
                        '<button class="btn btn-close" onclick="closeModal()">Cancel</button>' +
                    '</div>';
                
                document.getElementById('modal-content').innerHTML = modalHtml;
                document.getElementById('email-modal').style.display = 'block';
            } catch (error) {
                console.error('Error showing date range emails:', error);
                alert('Error loading date range emails: ' + error.message);
            }
        }
        
        async function applyDateRangeRecommendations() {
            try {
                if (!currentDateRange) {
                    alert('No date range selected');
                    return;
                }
                
                if (!confirm('Apply AI recommendations to all emails in this date range?')) {
                    return;
                }
                
                const response = await fetch('/api/date-ranges/apply-recommendations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        start_date: currentDateRange.start,
                        end_date: currentDateRange.end
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert('‚úÖ ' + result.message);
                    closeModal();
                    loadStats();
                    await loadDateRanges();
                } else {
                    alert('Error applying recommendations');
                }
            } catch (error) {
                console.error('Error applying recommendations:', error);
                alert('Error: ' + error.message);
            }
        }
        
        async function makeBulkDateRangeDecision(action, aiRecommendation) {
            try {
                // Determine if we're agreeing with AI recommendation
                const approved = (action === 'deleted' && aiRecommendation === 'delete') || 
                                (action === 'kept' && aiRecommendation === 'keep') ||
                                (action === 'archived' && aiRecommendation === 'archive');
                
                const response = await fetch('/api/date-ranges/decide-bulk', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        start_date: currentDateRange.start,
                        end_date: currentDateRange.end,
                        approved: approved, 
                        action_taken: action 
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert('‚úÖ ' + result.message);
                    closeModal();
                    loadStats();
                    loadDateRanges();
                } else {
                    alert('Error recording bulk decision');
                }
            } catch (error) {
                console.error('Error making bulk date range decision:', error);
                alert('Error: ' + error.message);
            }
        }
        
        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                if (!response.ok) throw new Error('Stats request failed');
                const stats = await response.json();
                document.getElementById('pending-count').textContent = stats.total_pending_review;
                document.getElementById('processed-count').textContent = stats.total_emails_processed;
                document.getElementById('accuracy-rate').textContent = stats.ai_accuracy_rate.toFixed(1) + '%';
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }
        
        async function loadEmails(searchTerm = null) {
            try {
                const unviewedOnly = document.getElementById('unviewed-only')?.checked || false;
                
                let url = '/api/emails/pending?';
                const params = [];
                if (searchTerm) {
                    params.push('search=' + encodeURIComponent(searchTerm));
                }
                if (unviewedOnly) {
                    params.push('unviewed_only=true');
                }
                url += params.join('&');
                
                const response = await fetch(url);
                if (!response.ok) throw new Error('Email request failed');
                const emails = await response.json();
                
                const container = document.getElementById('email-container');
                
                if (emails.length === 0) {
                    let message = searchTerm 
                        ? 'No emails found matching "' + escapeHtml(searchTerm) + '"'
                        : (unviewedOnly ? 'No unviewed emails pending review' : 'No emails pending review');
                    container.innerHTML = '<div class="loading">' + message + '</div>';
                    return;
                }
                
                container.innerHTML = emails.map(email => 
                    '<div class="email-item" onclick="showEmailDetail(' + email.id + ')">' +
                        '<div class="email-sender">' + escapeHtml(email.sender) + '<span class="confidence" style="font-weight:normal; margin-left:10px;">ID: ' + email.email_id + '</span></div>' +
                        '<div class="email-subject">' + escapeHtml(email.subject) + '</div>' +
                        '<div>' +
                            '<span class="badge badge-' + email.recommendation + '">' + email.recommendation.toUpperCase() + '</span>' +
                            '<span class="confidence">Confidence: ' + (email.confidence_score * 100).toFixed(0) + '%</span>' +
                            '<span class="confidence">Category: ' + email.category + '</span>' +
                        '</div>' +
                    '</div>'
                ).join('');
            } catch (error) {
                console.error('Error loading emails:', error);
                document.getElementById('email-container').innerHTML = 
                    '<div class="error">Error loading emails: ' + error.message + '</div>';
            }
        }
        
        function searchEmails() {
            const searchInput = document.getElementById('search-input');
            const searchTerm = searchInput.value.trim();
            loadEmails(searchTerm || null);
        }
        
        function clearSearch() {
            document.getElementById('search-input').value = '';
            loadEmails();
        }
        
        // Allow Enter key to trigger search
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchEmails();
                    }
                });
            }
        });
        
        async function showEmailDetail(emailId) {
            try {
                currentEmailId = emailId;
                const response = await fetch('/api/emails/' + emailId);
                if (!response.ok) throw new Error('Failed to load email details');
                const email = await response.json();
                
                // Mark email as viewed
                try {
                    await fetch('/api/emails/' + emailId + '/viewed', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                } catch (viewError) {
                    console.warn('Failed to mark email as viewed:', viewError);
                    // Don't fail the whole operation if marking as viewed fails
                }
                
                document.getElementById('modal-content').innerHTML = 
                    '<h2>Email Details</h2>' +
                    '<p><strong>Email ID:</strong> ' + email.email_id + '</p>' +
                    '<p><strong>From:</strong> ' + escapeHtml(email.sender) + '</p>' +
                    '<p><strong>To:</strong> ' + escapeHtml(email.recipient) + '</p>' +
                    '<p><strong>Subject:</strong> ' + escapeHtml(email.subject) + '</p>' +
                    '<p><strong>Date:</strong> ' + new Date(email.received_date).toLocaleString() + '</p>' +
                    '<p><strong>Category:</strong> ' + email.category + ' | <strong>Priority:</strong> ' + email.priority + '</p>' +
                    '<h3>Body Preview</h3>' +
                    '<p style="background: #f9f9f9; padding: 15px; border-radius: 4px;">' + escapeHtml(email.body_preview) + '</p>' +
                    '<h3>AI Recommendation</h3>' +
                    '<p>' +
                        '<span class="badge badge-' + email.recommendation + '">' + email.recommendation.toUpperCase() + '</span>' +
                        '<span class="confidence">Confidence: ' + (email.confidence_score * 100).toFixed(0) + '%</span>' +
                    '</p>' +
                    '<p><strong>Reasoning:</strong> ' + escapeHtml(email.reasoning) + '</p>' +
                    '<div style="margin-top: 20px;">' +
                        '<button class="btn btn-approve" onclick="makeDecision(\'kept\', \'' + email.recommendation + '\')">‚úì Keep</button>' +
                        '<button class="btn btn-reject" onclick="makeDecision(\'deleted\', \'' + email.recommendation + '\')">‚úó Delete</button>' +
                        '<button class="btn" style="background:#f39c12; color:white;" onclick="makeDecision(\'archived\', \'' + email.recommendation + '\')">üóÑÔ∏è Archive</button>' +
                        '<button class="btn btn-close" onclick="closeModal()">Close</button>' +
                    '</div>';
                
                document.getElementById('email-modal').style.display = 'block';
            } catch (error) {
                console.error('Error showing email detail:', error);
                alert('Error loading email details: ' + error.message);
            }
        }
        
        async function makeDecision(action, aiRecommendation) {
            try {
                // Determine if we're agreeing with AI recommendation
                const approved = (action === 'deleted' && aiRecommendation === 'delete') || 
                                (action === 'kept' && aiRecommendation === 'keep') ||
                                (action === 'archived' && aiRecommendation === 'archive');
                
                const response = await fetch('/api/emails/' + currentEmailId + '/decide', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ approved: approved, action_taken: action })
                });
                
                if (response.ok) {
                    closeModal();
                    loadStats();
                    
                    // Refresh the group modal if we're in a group context
                    if (currentGroupContext === 'sender' && currentGroupIndex !== null) {
                        await loadSenders();  // Refresh main senders list
                        await showSenderEmails(currentGroupIndex);
                    } else if (currentGroupContext === 'category' && currentGroupIndex !== null) {
                        await loadCategories();  // Refresh main categories list
                        await showCategoryEmails(currentGroupIndex);
                    } else if (currentGroupContext === 'dateRange' && currentGroupIndex !== null) {
                        await loadDateRanges();  // Refresh main date ranges list
                        await showDateRangeEmails(currentGroupIndex);
                    } else {
                        loadEmails();
                    }
                } else {
                    alert('Error recording decision');
                }
            } catch (error) {
                console.error('Error making decision:', error);
                alert('Error: ' + error.message);
            }
        }
        
        function closeModal() {
            document.getElementById('email-modal').style.display = 'none';
            // Clear group context when closing modal
            currentGroupContext = null;
            currentGroupIndex = null;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Close modal when clicking outside
        document.getElementById('email-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
        
        // Initialize
        console.log('Email Scanner UI Starting...');
        loadStats();
        switchView('senders');  // Start with sender view
        
        // Refresh every 30 seconds
        setInterval(() => {
            loadStats();
            if (currentView === 'senders') {
                loadSenders();
            } else if (currentView === 'categories') {
                loadCategories();
            } else if (currentView === 'dates') {
                loadDateRanges();
            } else {
                loadEmails();
            }
        }, 30000);
    </script>
</body>
</html>
